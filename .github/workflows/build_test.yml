name: Build and Test

on:
    push:
        branches:
            - master
            - mkeller-SNOW-155318-migration
        tags:
            - v*
    pull_request:
        branches:
            - master
            - prep-**

jobs:
  lint:
    name: Check linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Display Python version
        run: python -c "import sys; import os; print(\"\n\".join(os.environ[\"PATH\"].split(os.pathsep))); print(sys.version); print(sys.executable);"
      - name: Upgrade setuptools, pip and wheel
        run: python -m pip install -U setuptools pip wheel
      - name: Install tox
        run: python -m pip install tox
      - name: Run fix_lint
        run: tox -e fix_lint

  build-manylinux:
    needs: lint
    name: Build linux-py${{ matrix.python-version }}
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux1_x86_64
    strategy:
      matrix:
        python-version: [3.5, 3.6, 3.7, 3.8]
    steps:
      - uses: actions/checkout@v1
      - name: Updating path
        run: |
          echo "::add-path::/opt/python/cp35-cp35m/bin/"
          echo "::add-path::/opt/python/cp36-cp36m/bin/"
          echo "::add-path::/opt/python/cp37-cp37m/bin/"
          echo "::add-path::/opt/python/cp38-cp38/bin/"
      - name: Display Python version
        run: python${{ matrix.python-version }} -c "import sys; print(sys.version)"
      - name: Upgrade setuptools and pip
        run: python${{ matrix.python-version }} -m pip install -U setuptools pip
      - name: Generate wheel
        run: python${{ matrix.python-version }} -m pip wheel -v -w dist_tmp --no-binary snowflake-connector-python .
      - name: Run auditwheel
        run: auditwheel repair --plat manylinux2010_x86_64 -L connector dist_tmp/snowflake_connector_python*.whl -w dist
      - name: Show wheels generated
        run: ls -lh dist
      - uses: actions/upload-artifact@v1
        with:
          name: linux_py${{ matrix.python-version }}
          path: dist/

  build-macos:
    needs: lint
    name: Build macos-py${{ matrix.python-version }}
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: [3.5, 3.6, 3.7, 3.8]
    steps:
      - uses: actions/checkout@v2
      - name: Setup python
        uses: actions/setup-python@master
        with:
          python-version: ${{ matrix.python-version }}
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Upgrade setuptools and pip
        run: python -m pip install -U setuptools pip auditwheel
      - name: Generate wheel
        run: MACOSX_DEPLOYMENT_TARGET=10.12 python -m pip wheel -v -w dist --no-binary snowflake-connector-python .
      - name: Show wheels generated
        run: ls -lh dist/snowflake_connector_python*.whl
      - uses: actions/upload-artifact@v2
        with:
          name: macos_py${{ matrix.python-version }}
          path: dist/snowflake_connector_python*.whl

#  test:
#    runs-on: ${{ matrix.os }}
#    strategy:
#      matrix:
#        os: [ubuntu-latest, macos-latest, windows-latest]
#        python-version: [3.5.1, 3.6, 3.7, 3.8]
#        exclude:
#          - os: windows-latest
#            python-version: 3.8
#    steps:
#      - uses: actions/checkout@v2
#      - name: Set up Python
#        uses: actions/setup-python@v2
#        with:
#          python-version: ${{ matrix.python-version }}
#      - name: Display Python version
#        run: python -c "import sys; print(sys.version)"
#      - name: Upgrade setuptools, pip and wheel
#        run: python -m pip install -U setuptools pip wheel
#      - name: Install tox
#        run: python -m pip install tox
