name: Create Requirements Files

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  create-req-files:
    name: Create requirements files
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Install Python Connector
        shell: bash
        run: |
          python -m pip install .
      - name: Create reqs file
        shell: bash
        run: |
          mkdir temp_requirement
          reqs_file="temp_requirement/requirements_$(python -c 'from sys import version_info;print(str(version_info.major)+str(version_info.minor))').reqs"
          echo "# Generated on: $(python --version)" >${reqs_file}
          echo "# With snowflake-connector-python version: $(python -m pip show snowflake-connector-python | grep ^Version | cut -d' ' -f2-)" >>${reqs_file}
          python -m pip freeze | grep -v snowflake-connector-python 1>>${reqs_file} 2>/dev/null
          echo '::set-output name=requirements_file::${reqs_file}'
        id: create-reqs-file
      - name: Show created req file
        shell: bash
        run: cat ${{ steps.create-reqs-file.outputs.requirements_file}}
      - uses: actions/upload-artifact@v2
        with:
          path: temp_requirement
          name: reqs_py${{ matrix.python-version }}

  push-files:
    needs: create-req-files
    name: Commit and push files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Download requirement files
        uses: actions/download-artifact@v2
        with:
          path: artifacts/
      - name: Collect all requirements files to one dir
        run: |
          python -c '
          from pathlib import Path
          import shutil

          src_dir = Path("artifacts")
          dst_dir = Path(".") / "tested_requirements"
          dst_dir.mkdir()
          for src_file in src_dir.glob("*/*.reqs"):
              dst_file = dst_dir / src_file.name
              print("{} copy to {}".format(src_file, dst_file))
              shutil.copy(str(src_file), str(dst_file))'
      - name: Commit and push new requirements files
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add tested_requirements
          git commit -m "Update requirements files" -a
#          git push
